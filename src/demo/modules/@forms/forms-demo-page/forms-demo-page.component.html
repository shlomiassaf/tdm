<div>
  <div>
    <button mat-mini-fab (click)="addEditUser()"><mat-icon>add</mat-icon></button>
    <mat-table #table [dataSource]="usersDatatSource">
      <ng-container matColumnDef="edit">
        <mat-header-cell *matHeaderCellDef></mat-header-cell>
        <mat-cell *matCellDef="let element">
          <button mat-icon-button (click)="addEditUser(element)">
            <mat-icon aria-label="Edit">edit</mat-icon>
          </button>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="id">
        <mat-header-cell *matHeaderCellDef> ID </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{element.id}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="name">
        <mat-header-cell *matHeaderCellDef> Name </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{element.name}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="email">
        <mat-header-cell *matHeaderCellDef> Email </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{element.email}} </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="userColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: userColumns;"
               class="element-row"
               matRipple
               [cdkDetailRow]="row" [cdkDetailRowTpl]="tpl"></mat-row>
    </mat-table>

    <br>
    <br>

    <mat-table #table [dataSource]="postsDatatSource">
      <ng-container matColumnDef="$$EDIT">
        <mat-header-cell *matHeaderCellDef></mat-header-cell>
        <mat-cell *matCellDef="let element">
          <button mat-icon-button (click)="onEdit(element)">
            <mat-icon aria-label="Edit">edit</mat-icon>
          </button>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="id">
        <mat-header-cell *matHeaderCellDef> ID </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{element.id}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="title">
        <mat-header-cell *matHeaderCellDef> Title </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{element.title}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="tldr">
        <mat-header-cell *matHeaderCellDef> TL;DL </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{element.tldr}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="content">
        <mat-header-cell *matHeaderCellDef> Content </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{element.content}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="author">
        <mat-header-cell *matHeaderCellDef> Author </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{element.author.name}} </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="postColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: postColumns;"></mat-row>
    </mat-table>
  </div>
</div>

<ng-template #tpl let-element>
  <div [@detailExpand] class="mat-row" style="overflow: hidden">
    <pre>{{element|json}}</pre>
  </div>
</ng-template>

<ng-template #postTemplate let-element>
  <dynamic-form #dyn
                [model]="element"
                [controlClass]="'dynamic-control-container'"
                [hotBind]="hotBind"
                (beforeRender)="beforeRenderPost($event)"
                [disabledState]="controlState.disabled"
                [hiddenState]="controlState.hidden">
    <div *dynamicFormOverride="'author'; let d" [formGroup]="d.formGroup">
      <mat-select formControlName="author" [placeholder]="d.meta.label">
        <mat-option *ngFor="let user of users" [value]="user">{{user.name}}</mat-option>
      </mat-select>
    </div>
  </dynamic-form>

  <div *ngIf="dyn.renderState | async; else state">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>
  <ng-template #state>
    <hr>

    <mat-checkbox [value]="hotBind" (change)="hotBind = $event.checked">Hot binding</mat-checkbox>
    <div style="font-size: 14px">
      <span style="display: inline-block; width: 30%"></span>
      <span style="display: inline-block; width: 35%">Disabled</span>
      <span style="display: inline-block">Hidden</span>
      <div *ngFor="let prop of ['id', 'title', 'tldr', 'content', 'level', 'audience', 'author']">
        <span style="display: inline-block; width: 30%">{{prop}}</span>
        <mat-checkbox style="display: inline-block; width: 35%"
                     [checked]="controlState.disabled.indexOf(prop) > -1"
                     (click)="handleControlState('disabled', prop)"></mat-checkbox>
        <mat-checkbox style="display: inline-block"
                     [checked]="controlState.hidden.indexOf(prop) > -1"
                     (click)="handleControlState('hidden', prop)"></mat-checkbox>
      </div>
    </div>
  </ng-template>

</ng-template>
