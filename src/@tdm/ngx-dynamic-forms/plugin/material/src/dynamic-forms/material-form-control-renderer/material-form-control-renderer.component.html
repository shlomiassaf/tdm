<ng-container *ngIf="!item.isArray; else FormArray;" [style.display]="item.hidden ? 'none' : undefined">
  <ng-container *ngIf="item.isChildForm;">
    <ng-container *ngTemplateOutlet="ChildForm; context: { $implicit: self, showLabels: false }"></ng-container>
  </ng-container>
  <ng-container *ngIf="!item.isChildForm;">
    <ng-container *ngTemplateOutlet="FormControl; context: { $implicit: self, showLabels: false }"></ng-container>
  </ng-container>
</ng-container>

<ng-template #FormControl let-ctx let-showLabels="showLabels">
  <ng-container [ngSwitch]="ctx.item.vType">
    <mat-checkbox *ngSwitchCase="'boolean'"
                  [formControl]="ctx.fControl">{{ showLabels ? ctx.item.label : ''}}</mat-checkbox>

    <mat-slide-toggle *ngSwitchCase="'slideToggle'"
                      [formControl]="ctx.fControl">{{ showLabels ? ctx.item.label : ''}}</mat-slide-toggle>

    <ng-container *ngSwitchCase="'slider'">
      <span *ngIf="showLabels">{{ctx.item.label}}</span>
      <mat-slider [formControl]="ctx.fControl"
                  thumbLabel="true"
                  [tickInterval]="1"
                  [min]="ctx.item.data?.min" [max]="ctx.item.data?.max"></mat-slider>
    </ng-container>

    <ng-container *ngSwitchCase="'radio'">
      <span *ngIf="showLabels">{{ctx.item.label}}</span>
      <mat-radio-group *ngSwitchCase="'radio'"
                       [class.vertical-mat-radio-group]="ctx.item.data?.vertical"
                       [formControl]="ctx.fControl">
        <mat-radio-button *ngFor="let sel of ctx.item.data.options" [value]="sel.value">{{sel.label || sel.value}}</mat-radio-button>
      </mat-radio-group>
    </ng-container>

    <mat-form-field *ngSwitchCase="'select'">
      <mat-select [formControl]="ctx.fControl"
                  [placeholder]="showLabels && ctx.item.label">
        <mat-option *ngFor="let sel of ctx.item.data.options" [value]="sel.value">{{sel.label || sel.value}}</mat-option>
      </mat-select>
      <mat-error *ngIf="hasError('required', ctx)">Required</mat-error>
    </mat-form-field>

    <mat-form-field *ngSwitchDefault>
      <input matInput
             [type]="ctx.item.vType"
             [formControl]="ctx.fControl"
             [placeholder]="showLabels && ctx.item.label"
             [min]="ctx.item.data?.min" [max]="ctx.item.data?.max">
      <mat-error *ngIf="hasError('required', ctx)">Required</mat-error>
    </mat-form-field>
  </ng-container>
</ng-template>

<ng-template #ChildForm let-ctx>
  <a mat-button (click)="editSingleChildForm(ctx)">edit</a>
  <mat-error style="display: inline;" *ngIf="hasError('required', ctx)">Required</mat-error>
</ng-template>

<ng-template #FormArray>

  <div class="dynamic-array">
    <mat-list class="dynamic-array-container">
      <ng-container *ngIf="item.isPrimitive">
        <mat-list-item *forFormArray="let c of fArray; index as i; tdmForm: tdmForm; fGroup: fGroup; item: item">
          <div class="dynamic-list-item" [class.selected]="selectedItem === i">
            <div class="dynamic-list-item-control">
              <ng-container *ngTemplateOutlet="FormControl; context: { $implicit: c, showLabels: false }"></ng-container>
            </div>
            <div class="dynamic-list-item-select">
              <mat-icon (click)="selectedItem = selectedItem === i ? undefined : i">check</mat-icon>
            </div>
          </div>
        </mat-list-item>
      </ng-container>

      <ng-container *ngIf="item.isChildForm && item.identity">
        <mat-list-item *forFormArray="let c of fArray; index as i; tdmForm: tdmForm; fGroup: fGroup; item: item">
          <div class="dynamic-list-item dynamic-list-item-ripple"
               mat-ripple
               [class.selected]="selectedItem === i"
               (click)="selectedItem = selectedItem === i ? undefined : i">
            <div class="dynamic-list-item-control dynamic-child-form-control">
              <mat-icon *ngIf="c.fControl.invalid"
                        class="dynamic-child-form-error" [matTooltip]="'Invalid'">error_outline</mat-icon>
              <span>{{c.fControl.get(item.identity)?.value}}</span>
            </div>
            <div class="dynamic-list-item-select">
              <mat-icon>check</mat-icon>
            </div>
          </div>
        </mat-list-item>
      </ng-container>
    </mat-list>

    <div class="dynamic-array-actions">
      <button *ngIf="fArray.length" mat-icon-button [disabled]="! (selectedItem > -1)" (click)="removeFromList()">
        <mat-icon>close</mat-icon>
      </button>
      <button *ngIf="fArray.length && !item.isPrimitive" mat-icon-button [disabled]="! (selectedItem > -1)" (click)="editFromList()">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button (click)="addToList()">
        <mat-icon style="color: green">add</mat-icon>
      </button>
    </div>
  </div>

</ng-template>
